# Hono Cloudflare Workers Starter

This is a starter template for building Cloudflare Workers using the [Hono](https://hono.dev/) framework. It integrates:

- **Better Auth**: Advanced authentication middleware.
- **Drizzle ORM**: Type-safe ORM for database operations.
- **libSQL (Turso DB)**: Fast, serverless database.
- **Zod Validators**: Type-safe validation for routes.
- **Scalar**: API documentation available at `/scalar` and `/auth/scalar`.

## Why This Stack?

All tools in this stack are free or low-cost, efficient, and easy to use.  
- **Hono** is lightweight and fast for edge/serverless environments.
- **Drizzle ORM** is simple, type-safe, and flexible for database changes.
- **libSQL (Turso DB)** is a serverless database with a generous free tier [turso.tech](https://turso.tech).
- **Better Auth** provides secure authentication out of the box.
- **Zod** makes validation easy and reliable.
- The project is easy to change:  
  - To switch databases, update the provider in lib/better-auth/index.ts, adjust Drizzle and client setup in db/index.ts, change db variable type in types.ts and run the codegen command (`pnpm run ba:g`, `npm run ba:g`, or `yarn ba:g`).

## Requirements

- **Node.js** (v18+ recommended)
- Any package manager:
  - **pnpm** (recommended): [pnpm.io](https://pnpm.io/)
  - **npm**: comes with Node.js
  - **yarn**: [yarnpkg.com](https://yarnpkg.com/)

## Installation

1. **Clone the repository**
   ```sh
   git clone https://github.com/sqot0/hono-cloudflare-workers-starter
   cd hono-cloudflare-workers-starter
   ```

2. **Install dependencies**
   - With pnpm:
     ```sh
     pnpm install
     ```
   - With npm:
     ```sh
     npm install
     ```
   - With yarn:
     ```sh
     yarn install
     ```

3. **Configure environment variables**  
   Fill in .env and .dev.vars.  
   See .dev.vars and .env.example for examples.

   You can generate a `BETTER_AUTH_SECRET` with:
   - pnpm:
     ```sh
     pnpx @better-auth/cli@latest secret
     ```
   - npm:
     ```sh
     npx @better-auth/cli@latest secret
     ```
   - yarn:
     ```sh
     yarn dlx @better-auth/cli@latest secret
     ```

4. **Database setup**
   - Create a Turso DB ([turso.tech](https://docs.turso.tech/introduction))
   - Add your database URL and Auth Token to .env
   - Run migrations:
     - pnpm:
       ```sh
       pnpm db:m
       ```
     - npm:
       ```sh
       npm run db:m
       ```
     - yarn:
       ```sh
       yarn db:m
       ```

5. **Generate Cloudflare type definitions**
   - pnpm:
     ```sh
     pnpm cf-typegen
     ```
   - npm:
     ```sh
     npm run cf-typegen
     ```
   - yarn:
     ```sh
     yarn cf-typegen
     ```

6. **Run locally**
   - pnpm:
     ```sh
     pnpm dev
     ```
   - npm:
     ```sh
     npm run dev
     ```
   - yarn:
     ```sh
     yarn dev
     ```

6. **Or run tests**
   - pnpm:
     ```sh
     pnpm test
     ```
   - npm:
     ```sh
     npm test
     ```
   - yarn:
     ```sh
     yarn test
     ```

## Scripts Explained

- `dev`: Start local development server with Wrangler.
- test: Run tests with Vitest.
- `format`: Format code with Prettier.
- `cf-typegen`: Generate Cloudflare type definitions.
- `db:g`: Generate Drizzle ORM schema.
- `db:m`: Run database migrations.
- `db:p`: Push schema changes to the database.
- `db:s`: Open Drizzle Studio for DB management.
- `ba:g`: Generate Better Auth schema in db/auth.schema.ts.

## Project Structure

```
src/
  index.ts           # Main app entry, endpoint config, error handling, route loading
  types.ts           # Hono context bindings, environment variables, middleware-assigned variables
  db/
    index.ts         # Drizzle ORM and libSQL client setup
    auth.schema.ts   # Auth schema generated by Better Auth
    schema.ts        # Main DB schema
    migrations/      # SQL migration files
  lib/
    openapi.ts       # OpenAPI docs setup
    router.ts        # App router
    better-auth/
      index.ts       # Better Auth options, database provider config
      options.ts     # Auth options
      utils.ts       # Utils function for Auth options
  middlewares/
    auth.middleware.ts   # Auth middleware
    db.middleware.ts     # DB middleware
    index.ts             # Middleware exports
  routes/
    index.ts             # Route loader
    auth/
      auth.routes.ts     # Auth routes
    todos/
      todos.routes.ts    # Todos routes (example)
      todos.schema.ts    # Todos validation schema
      todos.service.ts   # Todos service logic
test/
  env.d.ts           # Test environment types
  mockUser.ts        # Test user mocks
  setup.ts           # Test setup
  todos.test.ts      # Todos route tests
  tsconfig.json      # Test TypeScript config
.env.example         # Example environment variables
```

## How Things Work

- **types.ts**: Defines Hono context bindings and environment variables. Middleware assigns variables here for use in routes.
- **index.ts**: Main app configuration. Loads all endpoints, sets up error handling, and imports routes.
- **Creating new routes**:  
  - Example: See todos.routes.ts.  
    Create a new folder in routes, add your route file, and import it in index.ts.
- **src/middlewares/**:  
  - `auth.middleware.ts`: Handles authentication logic.
  - `db.middleware.ts`: Attaches database client to context.
  - `index.ts`: Exports all middlewares for easy import.
- **src/lib/better-auth/**:  
  - `index.ts`: Configure Better Auth options and set the database provider. Change provider here to switch DBs.
  - `options.ts`: Set authentication options.
- **src/db/**:  
  - Set up Drizzle ORM and libSQL client. Change here to switch ORM or DB client.
- **Tests (test folder)**:  
  - Contains setup, mocks, and example tests.  
  - Run all tests with `pnpm test`, `npm test`, or `yarn test`.

## API Documentation with OpenAPI

- Docs for your endpoints: [http://localhost:8787/scalar](http://localhost:8787/scalar)
- Docs for Better Auth endpoints: [http://localhost:8787/auth/scalar](http://localhost:8787/auth/scalar)

## GitHub Actions

This project includes a ready-to-use GitHub Action workflow for running auto tests on every push (`.github/workflows/test.yml`).

To use it, set the following secrets in your repository settings:

- `DATABASE_URL`
- `DATABASE_AUTH_TOKEN`
- `BETTER_AUTH_URL`
- `BETTER_AUTH_SECRET`

These secrets will be used to create `.env` and `.dev.vars` files during the workflow and run tests automatically.

---

If you have any questions, you can ask me at: [https://sqot0.my.id](https://sqot0.my.id)
